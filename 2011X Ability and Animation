local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local lp = Players.LocalPlayer
local char = lp.Character or lp.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local hum = char:WaitForChild("Humanoid")

-- Animation IDs
local dashAnimId = "rbxassetid://84493272045483"
local runAnimId = "rbxassetid://90374991500783"

-- Animation loader with elevated priority
local function playAnim(id, speed)
    local anim = Instance.new("Animation")
    anim.AnimationId = id
    local track = hum:LoadAnimation(anim)
    track.Priority = Enum.AnimationPriority.Action -- elevated priority
    track:Play()
    if speed then
        track:AdjustSpeed(speed)
    end
    return track
end

-- Ground check
local function isGrounded()
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {char}
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist
    local result = workspace:Raycast(hrp.Position, Vector3.new(0, -3, 0), rayParams)
    return result ~= nil
end

-- Dash logic
local dashCooldown = false
local dashTrack = nil

local function dash()
    if isGrounded() or dashCooldown then return end
    dashCooldown = true

    if dashTrack then dashTrack:Stop() end
    dashTrack = playAnim(dashAnimId, 0.5)

    local direction = hrp.CFrame.LookVector
    local velocity = (direction * 25 + Vector3.new(0, 10, 0)) / 0.2

    local bv = Instance.new("BodyVelocity")
    bv.Velocity = velocity
    bv.MaxForce = Vector3.new(1e5, 1e5, 1e5)
    bv.P = 1e4
    bv.Parent = hrp

    task.delay(0.2, function()
        bv:Destroy()
    end)

    -- Persist animation until grounded
    local groundedCheck
    groundedCheck = RunService.RenderStepped:Connect(function()
        if isGrounded() then
            groundedCheck:Disconnect()
            if dashTrack then dashTrack:Stop() end
            dashCooldown = false
        end
    end)
end

-- Input detection
UIS.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.Space then
        dash()
    end
end)

-- Slope-aware run animation (elevated priority, non-interruptive)
RunService.RenderStepped:Connect(function()
    local speed = hum.WalkSpeed
    local moveMag = hum.MoveDirection.Magnitude
    local playing = hum:GetPlayingAnimationTracks()

    local runPlaying = false
    for _, track in ipairs(playing) do
        if track.Animation.AnimationId == runAnimId then
            runPlaying = true
        end
    end

    local shouldRun = speed > 35 and moveMag > 0

    if shouldRun and not runPlaying then
        playAnim(runAnimId, 2)
    elseif not shouldRun and runPlaying then
        for _, track in ipairs(playing) do
            if track.Animation.AnimationId == runAnimId then
                track:Stop()
            end
        end
    end
end)
