local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local lp = Players.LocalPlayer
local char = lp.Character or lp.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local hum = char:WaitForChild("Humanoid")

-- Animation ID
local dashAnimId = "rbxassetid://84493272045483"

-- Animation loader
local function playAnim(id, speed)
    local anim = Instance.new("Animation")
    anim.AnimationId = id
    local track = hum:LoadAnimation(anim)
    track.Priority = Enum.AnimationPriority.Action
    track:Play()
    if speed then
        track:AdjustSpeed(speed)
    end
    return track
end

-- Refined ground check (slope-safe)
local function isTrulyAirborne()
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {char}
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist

    -- Cast slightly forward and downward to detect slopes
    local offset = hrp.CFrame.LookVector * 1.5 + Vector3.new(0, -3, 0)
    local result = workspace:Raycast(hrp.Position, offset, rayParams)
    return result == nil
end

-- Dash logic
local dashCooldown = false
local dashTrack = nil

local function dash()
    if not isTrulyAirborne() or dashCooldown then return end
    dashCooldown = true

    if dashTrack then dashTrack:Stop() end
    dashTrack = playAnim(dashAnimId, 0.5)

    local direction = hrp.CFrame.LookVector
    local velocity = (direction * 25 + Vector3.new(0, 10, 0)) / 0.2

    local bv = Instance.new("BodyVelocity")
    bv.Velocity = velocity
    bv.MaxForce = Vector3.new(1e5, 1e5, 1e5)
    bv.P = 1e4
    bv.Parent = hrp

    task.delay(0.2, function()
        bv:Destroy()
    end)

    -- Persist animation until grounded
    local groundedCheck
    groundedCheck = RunService.RenderStepped:Connect(function()
        if not isTrulyAirborne() then
            groundedCheck:Disconnect()
            if dashTrack then dashTrack:Stop() end
            dashCooldown = false
        end
    end)
end

-- Input detection
UIS.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.Space then
        dash()
    end
end)
