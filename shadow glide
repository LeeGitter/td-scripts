-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")

-- Player & Character
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local root = character:WaitForChild("HumanoidRootPart")

-- Animations
local animIdle = Instance.new("Animation")
animIdle.AnimationId = "rbxassetid://91713952120902"

local animWalk = Instance.new("Animation")
animWalk.AnimationId = "rbxassetid://127298485383182"

local animJump = Instance.new("Animation")
animJump.AnimationId = "rbxassetid://96227760954607"

local animGlide = Instance.new("Animation")
animGlide.AnimationId = "rbxassetid://110554238884342"

local animBoost = Instance.new("Animation")
animBoost.AnimationId = "rbxassetid://83858149912973"

-- UI
local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
screenGui.Name = "GlideFuelUI"

local fuelBar = Instance.new("Frame", screenGui)
fuelBar.Size = UDim2.new(0.2, 0, 0.02, 0)
fuelBar.Position = UDim2.new(0.78, 0, 0.95, 0)
fuelBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)

local fuelFill = Instance.new("Frame", fuelBar)
fuelFill.Size = UDim2.new(1, 0, 1, 0)
fuelFill.BackgroundColor3 = Color3.new(1, 0, 0)

local blackOverlay = Instance.new("Frame", screenGui)
blackOverlay.Size = UDim2.new(1, 0, 1, 0)
blackOverlay.BackgroundColor3 = Color3.new(0, 0, 0)
blackOverlay.BackgroundTransparency = 1
blackOverlay.ZIndex = 10

local injuredSound = Instance.new("Sound", SoundService)
injuredSound.SoundId = "rbxassetid://165969964"
injuredSound.Volume = 2

-- State
local fuel = 4
local maxFuel = 4
local blood = 5
local maxBlood = 5

local isGliding = false
local isBoosting = false
local isInjured = false
local canHop = true

local fuelDrainRate = 1
local boostDrainRate = fuelDrainRate * 3
local fuelRegenRate = 1 / 10
local bloodRegenRate = 1 / 8

local glideFallSpeed = -2
local boostSpeed = 50

local spaceHeld = false
local tHeld = false

-- Animation Tracks
local idleTrack, walkTrack

-- Helpers
local function tweenColor(color, duration)
    local tween = TweenService:Create(fuelFill, TweenInfo.new(duration), {BackgroundColor3 = color})
    tween:Play()
end

local function updateFuelBar()
    local percent = isInjured and (blood / maxBlood) or (fuel / maxFuel)
    fuelFill.Size = UDim2.new(math.clamp(percent, 0, 1), 0, 1, 0)
end

local function stopAll()
    for _, track in humanoid:GetPlayingAnimationTracks() do
        track:Stop()
    end
end

local function playIdle()
    if walkTrack and walkTrack.IsPlaying then walkTrack:Stop() end
    if not idleTrack or not idleTrack.IsPlaying then
        idleTrack = humanoid:LoadAnimation(animIdle)
        idleTrack.Priority = Enum.AnimationPriority.Action
        idleTrack.Looped = true
        idleTrack:Play()
    end
end

local function playWalk()
    if idleTrack and idleTrack.IsPlaying then idleTrack:Stop() end
    if not walkTrack or not walkTrack.IsPlaying then
        walkTrack = humanoid:LoadAnimation(animWalk)
        walkTrack.Priority = Enum.AnimationPriority.Action
        walkTrack.Looped = true
        walkTrack:AdjustSpeed(2)
        walkTrack:Play()
    end
end

local function enterInjured()
    isInjured = true
    isGliding = false
    isBoosting = false

    humanoid.WalkSpeed = 5
    humanoid.JumpPower = 0

    local animateScript = character:FindFirstChild("Animate")
    if animateScript then animateScript.Disabled = true end

    stopAll()
    playIdle()

    tweenColor(Color3.new(0.5, 0, 0), 0.3)
    blackOverlay.BackgroundTransparency = 0
    injuredSound:Play()

    task.delay(2, function()
        blackOverlay.BackgroundTransparency = 1
    end)
end

local function hopForward()
    if not isInjured or not canHop then return end
    canHop = false
    local direction = root.CFrame.LookVector
    local start = root.Position
    local goal = start + direction * 10 + Vector3.new(0, 4, 0)
    local t = 0
    local duration = 0.5

    local connection
    connection = RunService.RenderStepped:Connect(function(dt)
        t += dt
        if t >= duration then
            connection:Disconnect()
            return
        end
        local alpha = t / duration
        local pos = start:Lerp(goal, alpha)
        root.CFrame = CFrame.new(pos, pos + root.CFrame.LookVector)
    end)

    task.delay(0.6, function()
        canHop = true
    end)
end

-- Input
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.Space then
        spaceHeld = true
        if isInjured then hopForward() end
    elseif input.KeyCode == Enum.KeyCode.T then
        tHeld = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Space then
        spaceHeld = false
    elseif input.KeyCode == Enum.KeyCode.T then
        tHeld = false
    end
end)

-- Main Loop
RunService.RenderStepped:Connect(function(dt)
    if isInjured then
        humanoid.WalkSpeed = 5
        humanoid.JumpPower = 0

        if tHeld and blood > 0 then
            local forward = root.CFrame.LookVector * boostSpeed
            root.AssemblyLinearVelocity = Vector3.new(forward.X, 0, forward.Z)
            blood -= dt
            playWalk()
        else
            if blood < maxBlood then blood += bloodRegenRate * dt end
            playIdle()
        end

        blood = math.clamp(blood, 0, maxBlood)
        updateFuelBar()
        return
    end

    if isGliding then
        if humanoid.FloorMaterial ~= Enum.Material.Air then
            isGliding = false
            stopAll()
            tweenColor(Color3.new(1, 0, 0), 0.3)
            return
        end

        if fuel > 0 then
            if tHeld then
                isBoosting = true
                local forward = root.CFrame.LookVector * boostSpeed
                root.AssemblyLinearVelocity = Vector3.new(forward.X, glideFallSpeed, forward.Z)
                fuel -= boostDrainRate * dt
            else
                isBoosting = false
                root.AssemblyLinearVelocity = Vector3.new(root.AssemblyLinearVelocity.X, glideFallSpeed, root.AssemblyLinearVelocity.Z)
                fuel -= fuelDrainRate * dt
            end
        else
            enterInjured()
        end
    else
        if fuel < maxFuel then fuel += fuelRegenRate * dt end
    end

    fuel = math.clamp(fuel, 0, maxFuel)
    updateFuelBar()
end)
