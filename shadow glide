-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")

-- Player & Character
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local root = character:WaitForChild("HumanoidRootPart")

-- Animations
local animJumpTrigger = Instance.new("Animation")
animJumpTrigger.AnimationId = "rbxassetid://96227760954607"

local animGlide = Instance.new("Animation")
animGlide.AnimationId = "rbxassetid://110554238884342"

local animBoost = Instance.new("Animation")
animBoost.AnimationId = "rbxassetid://83858149912973"

local jumpTrack, glideTrack, boostTrack

-- UI Fuel Bar
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GlideFuelUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = StarterGui

local fuelBar = Instance.new("Frame")
fuelBar.Size = UDim2.new(0.3, 0, 0.02, 0)
fuelBar.Position = UDim2.new(0.35, 0, 0.95, 0)
fuelBar.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
fuelBar.BorderSizePixel = 0
fuelBar.Parent = screenGui

local fuelFill = Instance.new("Frame")
fuelFill.Size = UDim2.new(1, 0, 1, 0)
fuelFill.Position = UDim2.new(0, 0, 0, 0)
fuelFill.BackgroundColor3 = Color3.new(1, 0, 0)
fuelFill.BorderSizePixel = 0
fuelFill.Parent = fuelBar

-- State
local isGliding = false
local isBoosting = false
local fuel = 1
local maxFuel = 8
local fuelDrainRate = 1 / maxFuel
local boostDrainRate = fuelDrainRate * 3
local fuelRegenRate = 1 / 10
local glideFallSpeed = -2
local boostSpeed = 25

-- Input
local spaceHeld = false
local tHeld = false

-- Functions
local function startGlide()
    if isGliding or humanoid.FloorMaterial ~= Enum.Material.Air then return end
    isGliding = true

    jumpTrack = humanoid:LoadAnimation(animJumpTrigger)
    jumpTrack:Play()
    task.delay(0.5, function()
        if jumpTrack and jumpTrack.IsPlaying then jumpTrack:Stop() end
        if not isGliding then return end
        glideTrack = humanoid:LoadAnimation(animGlide)
        glideTrack:Play()
    end)
end

local function stopGlide()
    isGliding = false
    isBoosting = false
    if glideTrack then glideTrack:Stop() end
    if boostTrack then boostTrack:Stop() end
end

local function updateFuelBar()
    fuelFill.Size = UDim2.new(fuel / maxFuel, 0, 1, 0)
end

local function boostColorTween()
    local tween = TweenService:Create(fuelFill, TweenInfo.new(0.2), {BackgroundColor3 = Color3.new(1, 0.5, 0)})
    tween:Play()
end

local function resetColor()
    fuelFill.BackgroundColor3 = Color3.new(1, 0, 0)
end

-- Input Events
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.Space then
        spaceHeld = true
        startGlide()
    elseif input.KeyCode == Enum.KeyCode.T then
        tHeld = true
        boostColorTween()
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Space then
        spaceHeld = false
        stopGlide()
    elseif input.KeyCode == Enum.KeyCode.T then
        tHeld = false
        resetColor()
    end
end)

-- Main Loop
RunService.RenderStepped:Connect(function(dt)
    if isGliding then
        if fuel <= 0 or humanoid.FloorMaterial ~= Enum.Material.Air then
            stopGlide()
            return
        end

        if tHeld then
            if not isBoosting then
                isBoosting = true
                if glideTrack then glideTrack:Stop() end
                boostTrack = humanoid:LoadAnimation(animBoost)
                boostTrack:Play()
            end
            local forward = root.CFrame.LookVector * boostSpeed
            root.Velocity = Vector3.new(forward.X, glideFallSpeed, forward.Z)
            fuel -= boostDrainRate * dt
        else
            if isBoosting then
                isBoosting = false
                if boostTrack then boostTrack:Stop() end
                glideTrack = humanoid:LoadAnimation(animGlide)
                glideTrack:Play()
            end
            root.Velocity = Vector3.new(root.Velocity.X, glideFallSpeed, root.Velocity.Z)
            fuel -= fuelDrainRate * dt
        end
    else
        if fuel < maxFuel then
            fuel += fuelRegenRate * dt
        end
    end

    fuel = math.clamp(fuel, 0, maxFuel)
    updateFuelBar()
end)
