--// ðŸ”§ Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")

--// ðŸ‘¤ Player & Character
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local root = character:WaitForChild("HumanoidRootPart")

--// ðŸŽžï¸ Animations
local animJumpTrigger = Instance.new("Animation")
animJumpTrigger.AnimationId = "rbxassetid://96227760954607"

local animGlide = Instance.new("Animation")
animGlide.AnimationId = "rbxassetid://110554238884342"

local animBoost = Instance.new("Animation")
animBoost.AnimationId = "rbxassetid://83858149912973"

local animInjuredIdle = Instance.new("Animation")
animInjuredIdle.AnimationId = "rbxassetid://91713952120902"

local animInjuredWalk = Instance.new("Animation")
animInjuredWalk.AnimationId = "rbxassetid://127298485383182"

--// ðŸ§ª UI Fuel Bar
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GlideFuelUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local fuelBar = Instance.new("Frame")
fuelBar.Size = UDim2.new(0.2, 0, 0.02, 0)
fuelBar.Position = UDim2.new(0.78, 0, 0.95, 0)
fuelBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
fuelBar.BorderSizePixel = 0
fuelBar.Parent = screenGui

local fuelFill = Instance.new("Frame")
fuelFill.Size = UDim2.new(1, 0, 1, 0)
fuelFill.Position = UDim2.new(0, 0, 0, 0)
fuelFill.BackgroundColor3 = Color3.new(1, 0, 0)
fuelFill.BorderSizePixel = 0
fuelFill.Parent = fuelBar

--// ðŸ©¸ Injured Overlay + Sound
local blackOverlay = Instance.new("Frame")
blackOverlay.Size = UDim2.new(1, 0, 1, 0)
blackOverlay.BackgroundColor3 = Color3.new(0, 0, 0)
blackOverlay.BackgroundTransparency = 1
blackOverlay.ZIndex = 10
blackOverlay.Parent = screenGui

local injuredSound = Instance.new("Sound")
injuredSound.SoundId = "rbxassetid://165969964"
injuredSound.Volume = 2
injuredSound.Looped = false
injuredSound.Parent = SoundService

--// âš™ï¸ State Variables
local fuel = 4
local maxFuel = 4
local blood = 5
local maxBlood = 5

local isGliding = false
local isBoosting = false
local isInjured = false
local canHop = true

local fuelDrainRate = 1
local boostDrainRate = fuelDrainRate * 3
local fuelRegenRate = 1 / 10
local bloodRegenRate = 1 / 8

local glideFallSpeed = -2
local boostSpeed = 50

--// ðŸŽ® Input Flags
local spaceHeld = false
local tHeld = false

--// ðŸŽ¨ UI + Animation Helpers
local function tweenColor(color, duration)
    local tween = TweenService:Create(fuelFill, TweenInfo.new(duration), {BackgroundColor3 = color})
    tween:Play()
end

local function updateFuelBar()
    if isInjured then
        fuelFill.Size = UDim2.new(math.clamp(blood / maxBlood, 0, 1), 0, 1, 0)
    else
        local percent = fuel / maxFuel
        fuelFill.Size = UDim2.new(math.clamp(percent, 0, 1), 0, 1, 0)
    end
end

local function stopAllAnimations()
    for _, track in humanoid:GetPlayingAnimationTracks() do
        track:Stop()
    end
end

--// ðŸš¨ Injured State Trigger
local function enterInjuredState()
    isInjured = true
    isGliding = false
    isBoosting = false

    humanoid.WalkSpeed = 5
    humanoid.JumpPower = 0

    stopAllAnimations()
    local idleTrack = humanoid:LoadAnimation(animInjuredIdle)
    idleTrack.Priority = Enum.AnimationPriority.Action
    idleTrack:Play()

    tweenColor(Color3.new(0.5, 0, 0), 0.3)
    blackOverlay.BackgroundTransparency = 0
    injuredSound:Play()

    task.delay(2, function()
        blackOverlay.BackgroundTransparency = 1
    end)
end

--// ðŸ¦¿ Injured Hop Mechanic
if isInjured then
    humanoid.WalkSpeed = 5
    humanoid.JumpPower = 0

    -- Movement logic
    if tHeld and blood > 0 then
        local forward = root.CFrame.LookVector * boostSpeed
        root.AssemblyLinearVelocity = Vector3.new(forward.X, 0, forward.Z)
        blood -= dt

        -- Force walk animation every frame
        local hasWalk = false
        for _, track in humanoid:GetPlayingAnimationTracks() do
            if track.Animation.AnimationId == animInjuredWalk.AnimationId then
                hasWalk = true
                break
            end
        end
        if not hasWalk then
            stopAllAnimations()
            local walkTrack = humanoid:LoadAnimation(animInjuredWalk)
            walkTrack.Priority = Enum.AnimationPriority.Action
            walkTrack.Looped = true
            walkTrack:AdjustSpeed(2)
            walkTrack:Play()
        end
    else
        if blood < maxBlood then
            blood += bloodRegenRate * dt
        end

        -- Force idle animation every frame
        local hasIdle = false
        for _, track in humanoid:GetPlayingAnimationTracks() do
            if track.Animation.AnimationId == animInjuredIdle.AnimationId then
                hasIdle = true
                break
            end
        end
        if not hasIdle then
            stopAllAnimations()
            local idleTrack = humanoid:LoadAnimation(animInjuredIdle)
            idleTrack.Priority = Enum.AnimationPriority.Action
            idleTrack.Looped = true
            idleTrack:Play()
        end
    end

    blood = math.clamp(blood, 0, maxBlood)
    updateFuelBar()
    return
end
