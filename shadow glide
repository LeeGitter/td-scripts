-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

-- Player & Character
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local root = character:WaitForChild("HumanoidRootPart")

-- Animations
local animJumpTrigger = Instance.new("Animation")
animJumpTrigger.AnimationId = "rbxassetid://96227760954607"

local animGlide = Instance.new("Animation")
animGlide.AnimationId = "rbxassetid://110554238884342"

local animBoost = Instance.new("Animation")
animBoost.AnimationId = "rbxassetid://83858149912973"

local jumpTrack, glideTrack, boostTrack

-- UI Fuel Bar (Right Side)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GlideFuelUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local fuelBar = Instance.new("Frame")
fuelBar.Size = UDim2.new(0.2, 0, 0.02, 0)
fuelBar.Position = UDim2.new(0.78, 0, 0.95, 0)
fuelBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
fuelBar.BorderSizePixel = 0
fuelBar.Parent = screenGui

local fuelFill = Instance.new("Frame")
fuelFill.Size = UDim2.new(1, 0, 1, 0)
fuelFill.Position = UDim2.new(0, 0, 0, 0)
fuelFill.BackgroundColor3 = Color3.new(1, 0, 0)
fuelFill.BorderSizePixel = 0
fuelFill.Parent = fuelBar

-- State
local isGliding = false
local isBoosting = false
local isOvergliding = false
local isRecovering = false

local fuel = 4
local maxFuel = 4
local fuelDrainRate = 1 -- 4 seconds
local boostDrainRate = fuelDrainRate * 3
local fuelRegenRate = 1 / 10 -- 10 seconds
local glideFallSpeed = -2
local boostSpeed = 50

local overglideDrainRate = 1 / 2 -- lasts 2 seconds
local recoveryRate = 1 / 4 -- fills purple bar in 4 seconds

-- Input
local spaceHeld = false
local tHeld = false

-- Fuel Logic
local function drainFuel(rate, dt)
    fuel -= rate * dt
end

local function regenFuel(rate, dt)
    fuel += rate * dt
end

local function updateFuelBar()
    if isOvergliding or isRecovering then
        fuelFill.Size = UDim2.new(1, 0, 1, 0)
    else
        local percent = fuel / maxFuel
        fuelFill.Size = UDim2.new(math.clamp(percent, 0, 1), 0, 1, 0)
    end
end

local function tweenColor(color, duration)
    local tween = TweenService:Create(fuelFill, TweenInfo.new(duration), {BackgroundColor3 = color})
    tween:Play()
end

local function stopAllAnimations()
    if jumpTrack then jumpTrack:Stop() end
    if glideTrack then glideTrack:Stop() end
    if boostTrack then boostTrack:Stop() end
end

-- Glide Control
local function startGlide()
    if isGliding or humanoid.FloorMaterial ~= Enum.Material.Air then return end
    isGliding = true

    jumpTrack = humanoid:LoadAnimation(animJumpTrigger)
    jumpTrack:Play()

    task.delay(0.5, function()
        if not isGliding then return end
        if jumpTrack then jumpTrack:Stop() end
        glideTrack = humanoid:LoadAnimation(animGlide)
        glideTrack:Play()
    end)
end

local function stopGlide()
    isGliding = false
    isBoosting = false
    isOvergliding = false
    stopAllAnimations()
    tweenColor(Color3.new(1, 0, 0), 0.3)
end

-- Input Events
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.Space then
        spaceHeld = true
        if not isGliding then startGlide() end
    elseif input.KeyCode == Enum.KeyCode.T then
        tHeld = true
        tweenColor(Color3.new(1, 0.5, 0), 0.2)
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Space then
        spaceHeld = false
        if isOvergliding then
            isOvergliding = false
            isRecovering = true
            tweenColor(Color3.fromRGB(128, 0, 128), 0.3)
        else
            stopGlide()
        end
    elseif input.KeyCode == Enum.KeyCode.T then
        tHeld = false
        if not isOvergliding and not isRecovering then
            tweenColor(Color3.new(1, 0, 0), 0.2)
        end
    end
end)

-- Main Loop
RunService.RenderStepped:Connect(function(dt)
    if isRecovering then
        regenFuel(recoveryRate, dt)
        if fuel >= 0 then
            isRecovering = false
            tweenColor(Color3.new(1, 0, 0), 0.3)
        end
        updateFuelBar()
        return
    end

    if isGliding then
        if humanoid.FloorMaterial ~= Enum.Material.Air then
            stopGlide()
            return
        end

        if fuel > 0 then
            if tHeld then
                if not isBoosting then
                    isBoosting = true
                    if glideTrack then glideTrack:Stop() end
                    boostTrack = humanoid:LoadAnimation(animBoost)
                    boostTrack:Play()
                end
                local forward = root.CFrame.LookVector * boostSpeed
                root.AssemblyLinearVelocity = Vector3.new(forward.X, glideFallSpeed, forward.Z)
                drainFuel(boostDrainRate, dt)
            else
                if isBoosting then
                    isBoosting = false
                    if boostTrack then boostTrack:Stop() end
                    glideTrack = humanoid:LoadAnimation(animGlide)
                    glideTrack:Play()
                end
                root.AssemblyLinearVelocity = Vector3.new(root.AssemblyLinearVelocity.X, glideFallSpeed, root.AssemblyLinearVelocity.Z)
                drainFuel(fuelDrainRate, dt)
            end
        elseif spaceHeld then
            if not isOvergliding then
                isOvergliding = true
                stopAllAnimations()
                tweenColor(Color3.fromRGB(128, 0, 128), 0.3)
            end
            root.AssemblyLinearVelocity = Vector3.new(root.AssemblyLinearVelocity.X, 5, root.AssemblyLinearVelocity.Z)
            drainFuel(overglideDrainRate, dt)
            if fuel <= -2 then
                isOvergliding = false
                isRecovering = true
                tweenColor(Color3.fromRGB(128, 0, 128), 0.3)
            end
        else
            stopGlide()
        end
    else
        if fuel < maxFuel then
            regenFuel(fuelRegenRate, dt)
        end
    end

    updateFuelBar()
end)
