local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local player = Players.LocalPlayer

local function onCharacterAdded(character)
	local humanoid = character:WaitForChild("Humanoid")
	local hrp = character:WaitForChild("HumanoidRootPart")
	local camera = workspace.CurrentCamera

	local DEFAULT_SPEED = 28
	local BOOSTED_SPEED = 35
	local SPEED_BOOST_DURATION = 0.3
	local SLIDE_DURATION = 1.5 -- seconds

	humanoid.WalkSpeed = DEFAULT_SPEED

	local holdingE = false
	local wallJumpCooldown = false
	local sliding = false
	local dead = false

	-- Animation for E hold
	local animE = Instance.new("Animation")
	animE.AnimationId = "rbxassetid://132439703713518"
	local animTrackE = humanoid:LoadAnimation(animE)

	-- Slide animation (replace with your actual slide anim id)
	local slideAnimId = "rbxassetid://YOUR_SLIDE_ANIM_ID" -- <-- CHANGE THIS
	local animSlide = Instance.new("Animation")
	animSlide.AnimationId = slideAnimId
	local animTrackSlide = humanoid:LoadAnimation(animSlide)

	-- Input handling for E
	UIS.InputBegan:Connect(function(input, gpe)
		if gpe then return end
		if input.KeyCode == Enum.KeyCode.E and not holdingE then
			holdingE = true
			animTrackE:Play()
		end
	end)

	UIS.InputEnded:Connect(function(input)
		if input.KeyCode == Enum.KeyCode.E then
			holdingE = false
			animTrackE:Stop()
		end
	end)

	-- Physics while holding E (drag + slope boost)
	local physicsLoop = RunService.RenderStepped:Connect(function()
		if dead or not holdingE then return end

		hrp.Velocity *= 0.99 -- slow drag

		local rayParams = RaycastParams.new()
		rayParams.FilterDescendantsInstances = {character}
		rayParams.FilterType = Enum.RaycastFilterType.Blacklist

		local ray = workspace:Raycast(hrp.Position, Vector3.new(0, -5, 0), rayParams)
		if ray then
			local normal = ray.Normal
			if normal:Dot(Vector3.new(0, 1, 0)) < 0.95 then
				local downhill = (Vector3.new(0, -1, 0) - normal).Unit * 0.4
				hrp.Velocity += downhill
			end
		end
	end)

	-- Wall jump function
	local function doWallJump()
		if wallJumpCooldown or dead then return end

		local sides = {
			hrp.CFrame.RightVector,
			-hrp.CFrame.RightVector
		}

		local params = RaycastParams.new()
		params.FilterDescendantsInstances = {character}
		params.FilterType = Enum.RaycastFilterType.Blacklist

		for _, dir in ipairs(sides) do
			local hit = workspace:Raycast(hrp.Position, dir * 3, params)
			if hit and hit.Normal.Y < 0.5 then
				local forward = hrp.CFrame.LookVector
				humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
				hrp.Velocity = forward.Unit * 60 + Vector3.new(0, 50, 0)

				humanoid.WalkSpeed = BOOSTED_SPEED
				task.delay(SPEED_BOOST_DURATION, function()
					if not dead then
						humanoid.WalkSpeed = DEFAULT_SPEED
					end
				end)

				wallJumpCooldown = true
				task.delay(0.4, function()
					wallJumpCooldown = false
				end)

				break
			end
		end
	end

	-- Wall jump input
	UIS.InputBegan:Connect(function(input, gpe)
		if gpe then return end
		if input.KeyCode == Enum.KeyCode.Space then
			doWallJump()
		end
	end)

	-- --- SLIDE IMPLEMENTATION ---
	local slideStartTime = 0

	-- Controls lock vars
	local moveVector = Vector3.new(0,0,0)
	local driftSpeed = 32 -- slide movement speed

	-- Slide toggle
	local function toggleSlide()
		if sliding then
			-- Stop slide
			sliding = false
			animTrackSlide:Stop()
			humanoid.WalkSpeed = DEFAULT_SPEED
		else
			-- Start slide
			sliding = true
			slideStartTime = tick()
			animTrackSlide:Play()
			humanoid.WalkSpeed = 0 -- Lock normal walk speed while sliding
		end
	end

	-- Listen for T key for slide toggle
	UIS.InputBegan:Connect(function(input, gpe)
		if gpe then return end
		if input.KeyCode == Enum.KeyCode.T then
			toggleSlide()
		end
	end)

	-- Movement locking + drifting during slide
	RunService.RenderStepped:Connect(function()
		if dead then return end

		if sliding then
			-- Auto end slide after duration
			if tick() - slideStartTime > SLIDE_DURATION then
				sliding = false
				animTrackSlide:Stop()
				humanoid.WalkSpeed = DEFAULT_SPEED
				return
			end

			-- Get move input direction from keys (WASD)
			local forward = 0
			local right = 0

			if UIS:IsKeyDown(Enum.KeyCode.W) then forward += 1 end
			if UIS:IsKeyDown(Enum.KeyCode.S) then forward -= 1 end
			if UIS:IsKeyDown(Enum.KeyCode.A) then right -= 1 end
			if UIS:IsKeyDown(Enum.KeyCode.D) then right += 1 end

			local camCF = camera.CFrame
			local moveDir = (camCF.LookVector * forward + camCF.RightVector * right)
			if moveDir.Magnitude > 0 then
				moveDir = moveDir.Unit
			end

			-- Apply drifting: move the HRP by a small velocity in moveDir direction
			local driftVelocity = moveDir * driftSpeed
			-- Only apply horizontal velocity, keep Y velocity intact
			hrp.Velocity = Vector3.new(driftVelocity.X, hrp.Velocity.Y, driftVelocity.Z)
		end
	end)

	-- Cleanup
	humanoid.Died:Connect(function()
		dead = true
		animTrackE:Stop()
		animTrackSlide:Stop()
		script:Destroy()
	end)
end

if player.Character then
	onCharacterAdded(player.Character)
end

player.CharacterAdded:Connect(onCharacterAdded)

player.CharacterAdded:Once(function()
	script:Destroy()
end)
