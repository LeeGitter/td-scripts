local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local humanoid = char:WaitForChild("Humanoid")
local hrp = char:WaitForChild("HumanoidRootPart")

-- Animations
local glideAnim = Instance.new("Animation")
glideAnim.AnimationId = "rbxassetid://100787184418636"
local glideTrack = humanoid:LoadAnimation(glideAnim)

local dropAnim = Instance.new("Animation")
dropAnim.AnimationId = "rbxassetid://136757453797365"
local dropTrack = humanoid:LoadAnimation(dropAnim)

-- State
local gliding = false
local dropping = false
local dashingToCamera = false
local lastSpaceTap = 0
local spaceTapCount = 0
local glideStartTime = 0
local flyVel
local cameraDashStart = 0
local cameraDashDuration = 10

-- Constants
local maxSpeed = 65
local accelerationTime = 7
local descentRate = 2.5
local cameraDashSpeed = 50

-- Start gliding
local function startGlide()
    if gliding or dropping then return end
    if humanoid.FloorMaterial ~= Enum.Material.Air then return end

    gliding = true
    glideStartTime = tick()
    humanoid:ChangeState(Enum.HumanoidStateType.Freefall)
    glideTrack:Play()

    flyVel = Instance.new("BodyVelocity")
    flyVel.MaxForce = Vector3.new(1e5, 1e5, 1e5)
    flyVel.P = 10000
    flyVel.Velocity = Vector3.zero
    flyVel.Parent = hrp
end

-- Stop gliding
local function stopGlide()
    gliding = false
    if flyVel then flyVel:Destroy() end
    if glideTrack then glideTrack:Stop() end
end

-- Start dropping
local function startDrop()
    if not gliding then return end
    stopGlide()
    dropping = true
    dropTrack:Play()

    flyVel = Instance.new("BodyVelocity")
    flyVel.MaxForce = Vector3.new(0, 1e5, 0)
    flyVel.P = 10000
    flyVel.Velocity = Vector3.new(0, -50, 0)
    flyVel.Parent = hrp
end

-- Start camera dash
local function startCameraDash()
    dropping = false
    dashingToCamera = true
    cameraDashStart = tick()
    dropTrack:Play()

    if flyVel then flyVel:Destroy() end
    flyVel = Instance.new("BodyVelocity")
    flyVel.MaxForce = Vector3.new(1e5, 1e5, 1e5)
    flyVel.P = 10000
    flyVel.Parent = hrp
end

-- Input detection
UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end

    if input.KeyCode == Enum.KeyCode.Space then
        local now = tick()
        if now - lastSpaceTap <= 1 then
            spaceTapCount += 1
        else
            spaceTapCount = 1
        end
        lastSpaceTap = now

        if spaceTapCount >= 2 then
            startGlide()
        end
    end

    if input.KeyCode == Enum.KeyCode.T then
        startDrop()
    end
end)

UIS.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Space then
        if gliding then stopGlide() end
    end
end)

-- Main loop
RunService.RenderStepped:Connect(function()
    if dashingToCamera then
        if tick() - cameraDashStart >= cameraDashDuration then
            dashingToCamera = false
            if flyVel then flyVel:Destroy() end
            return
        end

        local cam = workspace.CurrentCamera
        local direction = (cam.CFrame.Position - hrp.Position).Unit
        flyVel.Velocity = direction * cameraDashSpeed
        return
    end

    if dropping then
        if humanoid.FloorMaterial ~= Enum.Material.Air then
            startCameraDash()
        end
        return
    end

    if gliding then
        if humanoid.FloorMaterial ~= Enum.Material.Air then
            stopGlide()
            return
        end

        local elapsed = tick() - glideStartTime
        local speed = math.clamp((maxSpeed * (elapsed / accelerationTime)), 0, maxSpeed)

        local moveDir = humanoid.MoveDirection
        local forward = hrp.CFrame.LookVector * speed
        local steer = moveDir.Magnitude > 0 and moveDir.Unit * 20 or Vector3.zero
        local downward = Vector3.new(0, -descentRate, 0)

        if flyVel then
            flyVel.Velocity = forward + steer + downward
        end
    end
end)
