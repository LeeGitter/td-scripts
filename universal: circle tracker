local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local torso = character:WaitForChild("Torso")

-- Settings
local tailLength = 4
local segmentLength = 1.5
local tailOffset = Vector3.new(0, -0.5, 1.5)

-- Cleanup old tail
if character:FindFirstChild("DynamicTail") then
	character.DynamicTail:Destroy()
end

local tailModel = Instance.new("Model")
tailModel.Name = "DynamicTail"
tailModel.Parent = character

-- Base attachment on torso
local rootAttachment = Instance.new("Attachment")
rootAttachment.Name = "RootAttachment"
rootAttachment.Position = tailOffset
rootAttachment.Parent = torso

-- Create tail segments
local segments = {}
local lastAttachment = rootAttachment
local lastPart = torso

for i = 1, tailLength do
	local part = Instance.new("Part")
	part.Size = Vector3.new(0.4, 0.4, segmentLength)
	part.Anchored = false
	part.CanCollide = false
	part.Massless = true
	part.Material = Enum.Material.Neon
	part.Color = Color3.fromRGB(255 - (i * 30), 100 + i * 30, 255)
	part.Name = "TailSegment" .. i
	part.Parent = tailModel

	local att0 = Instance.new("Attachment")
	att0.Position = Vector3.new(0, 0, -segmentLength/2)
	att0.Parent = part

	local att1 = Instance.new("Attachment")
	att1.Position = Vector3.new(0, 0, segmentLength/2)
	att1.Parent = part

	local socket = Instance.new("BallSocketConstraint")
	socket.Attachment0 = lastAttachment
	socket.Attachment1 = att0
	socket.TwistLimitsEnabled = true
	socket.TwistLowerAngle = -15
	socket.TwistUpperAngle = 15
	socket.LimitsEnabled = true
	socket.UpperAngle = 25
	socket.Parent = part

	local align = Instance.new("AlignOrientation")
	align.Attachment0 = att0
	align.Attachment1 = lastAttachment
	align.ReactionTorqueEnabled = true
	align.Responsiveness = 15
	align.MaxTorque = 10000
	align.Mode = Enum.OrientationAlignmentMode.OneAttachment
	align.Parent = part

	lastAttachment = att1
	lastPart = part
	table.insert(segments, part)
end

-- Tail flick / wobble dynamic motion
local lastVelocity = Vector3.new()

RunService.RenderStepped:Connect(function()
	local currentVelocity = torso.Velocity
	local velocityChange = (currentVelocity - lastVelocity).Magnitude
	lastVelocity = currentVelocity

	for i, seg in ipairs(segments) do
		-- Add slight sinusoidal curl over time
		local curl = math.sin(tick() * 3 + i) * 5
		local att = seg:FindFirstChildWhichIsA("Attachment")
		if att then
			att.Rotation = Vector3.new(curl, 0, 0)
		end

		-- If player makes a sudden move, flick tail more
		if velocityChange > 2 then
			local flick = math.random(-15, 15)
			att.Rotation = Vector3.new(flick, 0, 0)
		end
	end
end)
