local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local torso = character:WaitForChild("Torso")

-- Settings
local tailLength = 4
local segmentLength = 1.5
local tailOffset = Vector3.new(0, -0.5, 1.5) -- slightly lower and back

-- Cleanup old tail
if character:FindFirstChild("DynamicTail") then
	character.DynamicTail:Destroy()
end

local tailModel = Instance.new("Model")
tailModel.Name = "DynamicTail"
tailModel.Parent = character

-- Create segments
local segments = {}
local lastAttachment = Instance.new("Attachment")
lastAttachment.Name = "RootAttachment"
lastAttachment.Parent = torso
lastAttachment.Position = tailOffset

for i = 1, tailLength do
	local part = Instance.new("Part")
	part.Size = Vector3.new(0.5, 0.5, segmentLength)
	part.Anchored = false
	part.CanCollide = false
	part.Massless = true
	part.Material = Enum.Material.Neon
	part.Color = Color3.fromRGB(255 - (i * 30), 80 + i * 20, 255)
	part.Name = "TailSegment" .. i
	part.Parent = tailModel

	local att0 = Instance.new("Attachment")
	att0.Position = Vector3.new(0, 0, -segmentLength/2)
	att0.Parent = part

	local att1 = Instance.new("Attachment")
	att1.Position = Vector3.new(0, 0, segmentLength/2)
	att1.Parent = part

	local constraint = Instance.new("BallSocketConstraint")
	constraint.Attachment0 = lastAttachment
	constraint.Attachment1 = att0
	constraint.LimitsEnabled = true
	constraint.TwistLimitsEnabled = true
	constraint.UpperAngle = 25
	constraint.TwistLowerAngle = -15
	constraint.TwistUpperAngle = 15
	constraint.Parent = part

	local align = Instance.new("AlignOrientation")
	align.Attachment0 = att0
	align.Attachment1 = lastAttachment
	align.Mode = Enum.OrientationAlignmentMode.OneAttachment
	align.ReactionTorqueEnabled = true
	align.Responsiveness = 5
	align.MaxTorque = 5000
	align.Parent = part

	-- Position the part at initial spot
	part.CFrame = torso.CFrame * CFrame.new(0, -0.5, 1.5 + segmentLength * (i - 1))

	table.insert(segments, part)
	lastAttachment = att1
end

-- Make it pitch up slightly over time
RunService.RenderStepped:Connect(function()
	for i, part in ipairs(segments) do
		local offset = Vector3.new(0, 0.1 * i, 0) -- pitch upward
		local base = torso.CFrame * CFrame.new(tailOffset + Vector3.new(0, 0, segmentLength * (i - 1)))
		part.Velocity = torso.Velocity -- follow motion
		part.CFrame = base + offset
	end
end)
