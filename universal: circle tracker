local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local torso = character:WaitForChild("Torso")

-- Tail Settings
local NUM_SEGMENTS = 16
local BASE_SIZE = Vector3.new(0.5, 0.5, 0.5)
local LENGTH_PER_SEGMENT = 0.7

-- Base offset: **lower** near waist/back (Y negative), Z back positive
local BASE_OFFSET = Vector3.new(0, -1.2, 1.5)

-- How much the tail tip rises relative to base (total elevation gain)
local TIP_ELEVATION = 2.5

local BUILD_DELAY = 0.1

local segments = {}
local tailRootAttachment = nil
local cube = nil
local cubeHue = 0

-- Cleanup old tail
if character:FindFirstChild("TailRoot") then
	character.TailRoot:Destroy()
end

-- Create root attachment on torso at base offset
tailRootAttachment = Instance.new("Attachment")
tailRootAttachment.Name = "TailRoot"
tailRootAttachment.Position = BASE_OFFSET
tailRootAttachment.Parent = torso

-- Create one tail segment, attaching to previous attachment
local function createSegment(index, parentAttachment)
	local part = Instance.new("Part")
	part.Name = "TailSegment_" .. index
	part.Size = BASE_SIZE + Vector3.new(index * 0.05, index * 0.05, LENGTH_PER_SEGMENT)
	part.Material = Enum.Material.Neon
	part.CanCollide = false
	part.Anchored = false
	part.Massless = true
	part.CastShadow = false
	part.Parent = workspace

	-- Calculate color rainbow gradient along tail
	part.Color = Color3.fromHSV((index / NUM_SEGMENTS) % 1, 1, 1)

	local att1 = Instance.new("Attachment", part)
	local att2 = Instance.new("Attachment", parentAttachment.Parent)

	att1.Position = Vector3.new(0, 0, -LENGTH_PER_SEGMENT / 2)
	att2.Position = Vector3.new(0, 0, LENGTH_PER_SEGMENT / 2)

	local ballSocket = Instance.new("BallSocketConstraint")
	ballSocket.Attachment0 = att2
	ballSocket.Attachment1 = att1
	ballSocket.LimitsEnabled = true
	ballSocket.TwistLimitsEnabled = true
	ballSocket.UpperAngle = 25 -- Allow more bending
	ballSocket.TwistLowerAngle = -15
	ballSocket.TwistUpperAngle = 15
	ballSocket.Parent = part

	return part, att1
end

-- Coroutine to build tail gradually
coroutine.wrap(function()
	local lastAttachment = tailRootAttachment

	for i = 1, NUM_SEGMENTS do
		local segment, newAttachment = createSegment(i, lastAttachment)
		table.insert(segments, segment)
		lastAttachment = newAttachment

		-- Calculate elevation for this segment: linearly interpolate from base offset Y to base + TIP_ELEVATION
		local yOffset = BASE_OFFSET.Y + (TIP_ELEVATION * (i - 1) / (NUM_SEGMENTS - 1))
		-- Position segments in a straight line backward on Z and rising on Y
		segment.CFrame = torso.CFrame * CFrame.new(0, yOffset, -BASE_OFFSET.Z - LENGTH_PER_SEGMENT * (i - 1))

		wait(BUILD_DELAY)
	end

	-- Create spinning pastel cube at tip of tail
	cube = Instance.new("Part")
	cube.Shape = Enum.PartType.Block
	cube.Size = Vector3.new(1.5, 1.5, 1.5)
	cube.Material = Enum.Material.Neon
	cube.CanCollide = false
	cube.Anchored = false
	cube.Massless = true
	cube.CastShadow = false
	cube.Parent = workspace

	local attachTail = Instance.new("Attachment", segments[#segments])
	attachTail.Position = Vector3.new(0, 0, -LENGTH_PER_SEGMENT / 2)

	local attachCube = Instance.new("Attachment", cube)
	attachCube.Position = Vector3.new(0, 0, LENGTH_PER_SEGMENT / 2)

	local hinge = Instance.new("HingeConstraint")
	hinge.Attachment0 = attachTail
	hinge.Attachment1 = attachCube
	hinge.Parent = cube
	hinge.MotorMaxTorque = math.huge
	hinge.AngularVelocity = 5
end)()

local lastPos = torso.Position
RunService.RenderStepped:Connect(function()
	if #segments == 0 then return end

	local moveVec = (torso.Position - lastPos)
	lastPos = torso.Position

	for i, part in ipairs(segments) do
		local phase = tick() * 2 + i
		local sway = math.sin(phase) * (moveVec.Magnitude * 5)
		local offset = Vector3.new(sway * 0.05, 0, 0)
		part.AssemblyLinearVelocity = offset
	end

	-- Pastel cube color cycling and spinning
	if cube then
		cubeHue = (cubeHue + 0.005) % 1
		cube.Color = Color3.fromHSV(cubeHue, 0.4, 1) -- pastel saturation 0.4, brightness 1
		cube.RotVelocity = Vector3.new(2, 4, 1)
	end
end)
