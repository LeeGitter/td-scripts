local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")

local wingSize = Vector3.new(3, 3, 0.1)
local flapSpeedMultiplier = 5
local afterimageLifetime = 0.5
local afterimageFadeTime = 0.5
local afterimageSpawnInterval = 0.05
local wingImageId = "rbxassetid://75171109405668"

local function createWing()
    local wing = Instance.new("Part")
    wing.Name = "Wing"
    wing.Size = wingSize
    wing.Anchored = true  -- Important: anchored, no physics interaction
    wing.CanCollide = false
    wing.Transparency = 0
    wing.Material = Enum.Material.Neon
    wing.CastShadow = false
    wing.Parent = character

    -- Smooth surfaces for clean visuals
    wing.TopSurface = Enum.SurfaceType.Smooth
    wing.BottomSurface = Enum.SurfaceType.Smooth
    wing.FrontSurface = Enum.SurfaceType.Smooth
    wing.BackSurface = Enum.SurfaceType.Smooth
    wing.LeftSurface = Enum.SurfaceType.Smooth
    wing.RightSurface = Enum.SurfaceType.Smooth

    local decal = Instance.new("Decal")
    decal.Face = Enum.NormalId.Front
    decal.Texture = wingImageId
    decal.Transparency = 0
    decal.Parent = wing

    return wing
end

local leftWing = createWing()
local rightWing = createWing()

local flapAngle = 0
local lastAfterimageTime = 0

local function createAfterimage(wing)
    local clone = wing:Clone()
    clone.Anchored = true
    clone.CanCollide = false
    clone.Parent = workspace
    clone.Material = Enum.Material.Neon
    clone.CastShadow = false

    local hue = 0
    local colorCycleSpeed = 10

    spawn(function()
        local startTime = tick()
        while tick() - startTime < afterimageLifetime do
            local dt = RunService.Heartbeat:Wait()
            hue = (hue + colorCycleSpeed * dt) % 1
            clone.Color = Color3.fromHSV(hue, 1, 1)

            local elapsed = tick() - startTime
            if elapsed > afterimageLifetime - afterimageFadeTime then
                clone.Transparency = math.clamp((elapsed - (afterimageLifetime - afterimageFadeTime)) / afterimageFadeTime, 0, 1)
            end
        end
        clone:Destroy()
    end)
end

RunService.Heartbeat:Connect(function(dt)
    local speed = rootPart.Velocity.Magnitude
    flapAngle = flapAngle + dt * flapSpeedMultiplier * speed
    local flapOffset = math.sin(flapAngle) * math.rad(20)

    -- Position wings behind the HumanoidRootPart, flap rotation on Z axis
    -- Correct offset: wings are behind rootPart, slightly to left and right on X axis, no rotation on rootPart (keep wings independent)
    local rootCFrame = rootPart.CFrame

    -- Left wing: offset to left (-X), behind (-Z), flap rotation around Z axis
    leftWing.CFrame = rootCFrame * CFrame.new(-2, 0, -1) * CFrame.Angles(0, 0, flapOffset)
    -- Right wing: offset to right (+X), behind (-Z), flipped 180 on Y and flap rotation opposite on Z
    rightWing.CFrame = rootCFrame * CFrame.new(2, 0, -1) * CFrame.Angles(0, math.rad(180), -flapOffset)

    if speed > 1 then
        if tick() - lastAfterimageTime > afterimageSpawnInterval then
            createAfterimage(leftWing)
            createAfterimage(rightWing)
            lastAfterimageTime = tick()
        end
    end
end)
