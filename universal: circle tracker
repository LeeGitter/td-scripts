local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local camera = Workspace.CurrentCamera

-- Config for more sensitive FOV and vignette bopping
local BASE_FOV = 70
local MAX_FOV_INCREASE = 8           -- bigger zoom
local BOP_SPEED = 6                  -- moderate bopping speed
local VIGNETTE_BOP_SPEED = 8         -- moderate vignette pulse speed
local VIGNETTE_INTENSITY_MAX = 0.25  -- stronger vignette
local LOUDNESS_THRESHOLD = 400       -- lowered threshold for more sensitivity

-- Create VignetteEffect
local vignette = Instance.new("VignetteEffect")
vignette.Parent = camera
vignette.Enabled = true
vignette.Intensity = 0

-- Create ColorCorrectionEffect for rainbow tint
local colorCorrection = Instance.new("ColorCorrectionEffect")
colorCorrection.Parent = camera
colorCorrection.Enabled = true
colorCorrection.TintColor = Color3.new(1, 1, 1)

local timeSinceLoud = 0
local active = false

RunService.RenderStepped:Connect(function(dt)
    local maxLoudness = 0
    for _, sound in ipairs(Workspace:GetDescendants()) do
        if sound:IsA("Sound") and sound.Playing and sound.Parent and sound.Parent:IsA("BasePart") then
            local pos = sound.Parent.Position
            local dist = (pos - hrp.Position).Magnitude
            if dist <= 50 then
                maxLoudness = math.max(maxLoudness, sound.PlaybackLoudness or 0)
            end
        end
    end

    if maxLoudness > LOUDNESS_THRESHOLD then
        active = true
        timeSinceLoud = 0
    else
        timeSinceLoud = timeSinceLoud + dt
        if timeSinceLoud > 0.5 then
            active = false
            vignette.Intensity = 0
            colorCorrection.TintColor = Color3.new(1, 1, 1)
            camera.FieldOfView = BASE_FOV
            return
        end
    end

    if active then
        timeSinceLoud = timeSinceLoud + dt

        local fovOffset = math.sin(timeSinceLoud * BOP_SPEED) * (MAX_FOV_INCREASE / 2) + (MAX_FOV_INCREASE / 2)
        camera.FieldOfView = BASE_FOV + fovOffset

        local vignettePulse = (math.sin(timeSinceLoud * VIGNETTE_BOP_SPEED) + 1) / 2
        vignette.Intensity = vignettePulse * VIGNETTE_INTENSITY_MAX

        local hue = (tick() * 2) % 1
        colorCorrection.TintColor = Color3.fromHSV(hue, 1, 1)
    end
end)
