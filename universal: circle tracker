local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

-- Crown Settings
local crownParts = {}
local partCount = 12
local orbitRadius = 2
local baseHeight = 1
local maxHeight = 3
local rotationSpeed = 2
local bobAmplitude = 2 -- maxHeight - baseHeight
local bobSpeed = 2

-- Effects
local defaultFOV = camera.FieldOfView
local fovBoost = 15
local highlightTime = 0
local highlight = nil
local triggeredParts = {}

-- UI Overlay
local overlayGui = Instance.new("ScreenGui")
overlayGui.Name = "RainbowOverlay"
overlayGui.ResetOnSpawn = false
overlayGui.Parent = player:WaitForChild("PlayerGui")

local overlayFrame = Instance.new("Frame")
overlayFrame.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
overlayFrame.BackgroundTransparency = 1
overlayFrame.Size = UDim2.fromScale(1, 1)
overlayFrame.BorderSizePixel = 0
overlayFrame.Parent = overlayGui

-- Gradient for rainbow effect
local gradient = Instance.new("UIGradient")
gradient.Rotation = 0
gradient.Color = ColorSequence.new({
		ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 0)),
		ColorSequenceKeypoint.new(0.16, Color3.fromRGB(255, 165, 0)),
		ColorSequenceKeypoint.new(0.33, Color3.fromRGB(255, 255, 0)),
		ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0, 255, 0)),
		ColorSequenceKeypoint.new(0.66, Color3.fromRGB(0, 0, 255)),
		ColorSequenceKeypoint.new(0.83, Color3.fromRGB(75, 0, 130)),
		ColorSequenceKeypoint.new(1, Color3.fromRGB(238, 130, 238))
})
gradient.Parent = overlayFrame

-- Create crown parts
for i = 1, partCount do
	local part = Instance.new("Part")
	part.Size = Vector3.new(0.4, 0.4, 0.4)
	part.Shape = Enum.PartType.Ball
	part.Anchored = true
	part.CanCollide = false
	part.Material = Enum.Material.Neon
	part.Color = Color3.fromRGB(255, 255, 255)
	part.Name = "CrownPart_"..i
	part.Parent = workspace
	crownParts[i] = part
end

-- Highlight generator
function createHighlight()
	if highlight then highlight:Destroy() end
	highlight = Instance.new("Highlight")
	highlight.FillColor = Color3.fromRGB(255, 0, 255)
	highlight.OutlineTransparency = 1
	highlight.FillTransparency = 0
	highlight.Parent = character
	highlight.Adornee = character

	-- Animate rainbow transition & fade out
	task.spawn(function()
		local duration = 1
		for t = 0, duration, RunService.RenderStepped:Wait() do
			local progress = t / duration
			highlight.FillTransparency = math.clamp(progress - 0.2, 0, 1)
			highlight.FillColor = Color3.fromHSV((tick() % 0.5) / 0.5, 1, 1)
		end
		highlight:Destroy()
		highlight = nil
	end)
end

-- Update loop
RunService.RenderStepped:Connect(function(dt)
	if not character or not character:FindFirstChild("HumanoidRootPart") then return end

	local time = tick()

	for i, part in ipairs(crownParts) do
		local angle = (i / partCount) * math.pi * 2 + time * rotationSpeed
		local offset = Vector3.new(math.cos(angle) * orbitRadius, 0, math.sin(angle) * orbitRadius)

		local bobOffset = math.sin(time * bobSpeed + i) * (bobAmplitude / 2)
		local targetPos = hrp.Position + Vector3.new(0, baseHeight + bobOffset, 0) + offset

		part.Position = part.Position:Lerp(targetPos, 0.25) -- smooth

		local verticalOffset = (part.Position - (hrp.Position + Vector3.new(0, baseHeight, 0))).Y

		if verticalOffset >= (maxHeight - baseHeight - 0.2) and not triggeredParts[part] then
			triggeredParts[part] = true

			-- Trigger effects
			highlightTime = 1
			createHighlight()
			camera.FieldOfView = defaultFOV + fovBoost
			overlayFrame.BackgroundTransparency = 0
		end
	end

	-- Handle FOV + overlay fading
	if highlightTime > 0 then
		highlightTime -= dt
		gradient.Rotation = (gradient.Rotation + dt * 180) % 360
	else
		camera.FieldOfView = defaultFOV
		overlayFrame.BackgroundTransparency = 1
		triggeredParts = {}
	end
end)
