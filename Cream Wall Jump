local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")

local WALL_JUMP_DISTANCE = 3 -- studs to detect wall
local WALL_JUMP_FORCE = 50 -- force away from wall
local WALL_JUMP_UPWARD_VELOCITY = 50
local WALL_JUMP_COOLDOWN = 0.2 -- seconds to prevent spam

local lastWallJumpTime = 0

-- Load wall jump animation with highest priority (Action)
local wallJumpAnim = Instance.new("Animation")
wallJumpAnim.AnimationId = "rbxassetid://80512938371187"
wallJumpAnim.Priority = Enum.AnimationPriority.Action
local wallJumpTrack = humanoid:LoadAnimation(wallJumpAnim)

local function findWallDirection()
    local directions = {
        hrp.CFrame.LookVector,  -- front
        -hrp.CFrame.LookVector, -- back
        hrp.CFrame.RightVector, -- right
        -hrp.CFrame.RightVector -- left
    }
    for _, dir in pairs(directions) do
        local origin = hrp.Position
        local raycastParams = RaycastParams.new()
        raycastParams.FilterDescendantsInstances = {character}
        raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

        local raycastResult = workspace:Raycast(origin, dir * WALL_JUMP_DISTANCE, raycastParams)
        if raycastResult and raycastResult.Instance and raycastResult.Instance.CanCollide then
            return dir
        end
    end
    return nil
end

local function playWallJumpAnimation()
    -- Stop all other animations instantly
    for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
        track:Stop(0)
    end

    -- Play wall jump animation
    wallJumpTrack:Play(0.1, 1, 1)

    -- Stop wall jump animation after 0.5 seconds
    delay(0.5, function()
        if wallJumpTrack.IsPlaying then
            wallJumpTrack:Stop(0)
        end
    end)
end

local function doWallJump()
    local now = tick()
    if now - lastWallJumpTime < WALL_JUMP_COOLDOWN then
        return
    end

    local state = humanoid:GetState()
    if not (state == Enum.HumanoidStateType.Freefall or state == Enum.HumanoidStateType.Jumping) then
        return
    end

    local wallDir = findWallDirection()
    if not wallDir then
        return
    end

    -- Force jump ignoring cooldown
    humanoid:ChangeState(Enum.HumanoidStateType.Jumping)

    -- Apply velocity away from wall + upward
    local velocity = -wallDir.Unit * WALL_JUMP_FORCE
    velocity = Vector3.new(velocity.X, WALL_JUMP_UPWARD_VELOCITY, velocity.Z)
    hrp.Velocity = velocity

    playWallJumpAnimation()

    lastWallJumpTime = now
end

UserInputService.JumpRequest:Connect(doWallJump)

player.CharacterAdded:Connect(function(char)
    character = char
    humanoid = character:WaitForChild("Humanoid")
    hrp = character:WaitForChild("HumanoidRootPart")

    wallJumpAnim = Instance.new("Animation")
    wallJumpAnim.AnimationId = "rbxassetid://80512938371187"
    wallJumpAnim.Priority = Enum.AnimationPriority.Action
    wallJumpTrack = humanoid:LoadAnimation(wallJumpAnim)
end)
