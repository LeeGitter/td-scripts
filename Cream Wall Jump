local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")

-- Load wall jump animation
local wallJumpAnim = Instance.new("Animation")
wallJumpAnim.AnimationId = "rbxassetid://80512938371187"
local wallJumpTrack = humanoid:LoadAnimation(wallJumpAnim)

local WALL_JUMP_DISTANCE = 3 -- studs to detect a wall nearby
local WALL_JUMP_FORCE = 50 -- velocity added away from wall
local WALL_JUMP_COOLDOWN = 0.2 -- very short cooldown to prevent spamming

local lastWallJumpTime = 0

-- Helper to check if a wall is near in a direction
local function findWallDirection()
    local directions = {
        hrp.CFrame.LookVector,  -- front
        -hrp.CFrame.LookVector, -- back
        hrp.CFrame.RightVector, -- right
        -hrp.CFrame.RightVector -- left
    }
    for _, dir in pairs(directions) do
        local origin = hrp.Position
        local raycastParams = RaycastParams.new()
        raycastParams.FilterDescendantsInstances = {character}
        raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

        local raycastResult = workspace:Raycast(origin, dir * WALL_JUMP_DISTANCE, raycastParams)
        if raycastResult and raycastResult.Instance and raycastResult.Instance.CanCollide then
            return dir
        end
    end
    return nil
end

local function doWallJump()
    local now = tick()
    if now - lastWallJumpTime < WALL_JUMP_COOLDOWN then
        return
    end

    -- Check if humanoid is jumping or falling (in air)
    local state = humanoid:GetState()
    if not (state == Enum.HumanoidStateType.Freefall or state == Enum.HumanoidStateType.Jumping) then
        return
    end

    -- Check wall near
    local wallDir = findWallDirection()
    if not wallDir then
        return
    end

    -- Apply opposite velocity from wall
    local jumpVelocity = -wallDir.Unit * WALL_JUMP_FORCE
    -- Also add some vertical velocity so jump actually lifts you
    jumpVelocity = Vector3.new(jumpVelocity.X, 50, jumpVelocity.Z)

    -- Directly set velocity (will override existing velocity)
    hrp.Velocity = jumpVelocity

    -- Play wall jump animation (restarts if playing)
    if wallJumpTrack.IsPlaying then
        wallJumpTrack:Stop()
    end
    wallJumpTrack:Play()

    lastWallJumpTime = now
end

-- Detect jump key pressed
UserInputService.JumpRequest:Connect(function()
    doWallJump()
end)

-- Also update character/humanoid if they respawn
player.CharacterAdded:Connect(function(char)
    character = char
    humanoid = character:WaitForChild("Humanoid")
    hrp = character:WaitForChild("HumanoidRootPart")

    wallJumpTrack = nil
    wallJumpAnim = Instance.new("Animation")
    wallJumpAnim.AnimationId = "rbxassetid://80512938371187"
    wallJumpTrack = humanoid:LoadAnimation(wallJumpAnim)
end)
